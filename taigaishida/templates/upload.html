{% extends "layout.html" %}

{% block content %}
<div class="flex items-center justify-center h-screen">
  <div class="w-full max-w-xs">
    <form id="upload-form" action="/upload-image" method="post" enctype="multipart/form-data" class="bg-gray-800 shadow-md rounded px-8 pt-6 pb-8 mb-4 text-white">
      <div class="mb-4">
        <label class="block text-green-500 text-sm font-bold mb-2" for="image">
          Choose an image to upload
        </label>
        <input id="file-input" class="shadow appearance-none border border-green-500 rounded w-full py-2 px-3 text-green-500 leading-tight focus:outline-none focus:shadow-outline" type="file" name="image">
      </div>
      <div class="mb-4">
        <label class="block text-green-500 text-sm font-bold mb-2" for="passphrase">
          Passphrase
        </label>
        <input id="passphrase-input" class="shadow appearance-none border border-green-500 rounded w-full py-2 px-3 text-green-500 leading-tight focus:outline-none focus:shadow-outline" type="password" name="passphrase">
      </div>
      <div class="flex items-center justify-between">
        <button id="upload-button" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline relative overflow-hidden" type="submit">
          <span id="button-text">Upload</span>
          <div id="button-spinner" class="h-5 w-5 border-2 border-white border-t-transparent rounded-full absolute top-1/2 left-1/2 transform-gpu -translate-x-1/2 -translate-y-1/2" style="animation: spin 1s linear infinite; display: none;"></div>
        </button>
      </div>
    </form>
    <div id="message" class="text-green-500 mt-4"></div>
  </div>
</div>

<script>
  document.getElementById('upload-form').addEventListener('submit', function(event) {
    event.preventDefault();
    
    const fileInput = document.getElementById('file-input');
    const passphraseInput = document.getElementById('passphrase-input');
    const uploadButton = document.getElementById('upload-button');
    const buttonText = document.getElementById('button-text');
    const buttonSpinner = document.getElementById('button-spinner');
    
    // Disable the button and show the spinner
    uploadButton.disabled = true;
    buttonSpinner.style.display = 'block';
    buttonText.textContent = 'Uploading...';
    
    const formData = new FormData();
    formData.append('image', fileInput.files[0]);
    formData.append('passphrase', passphraseInput.value);
    
    fetch('/upload-image', {
      method: 'POST',
      body: formData,
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(err => {
          throw new Error(err.detail);
        });
      }
      return response.json();
    })
    .then(data => {
      document.getElementById('message').textContent = 'Image uploaded successfully: ' + data.filename;
      console.log(data);
      
      // Show checkmark
      buttonSpinner.style.display = 'none';
      buttonText.textContent = '✅';
    })
    .catch(error => {
      document.getElementById('message').textContent = error.message;
      console.error(error);
      
      // Show X mark
      buttonSpinner.style.display = 'none';
      buttonText.textContent = '❌';
    })
    .finally(() => {
      // Enable the button again after a delay to allow user to see result
      setTimeout(() => {
        uploadButton.disabled = false;
        buttonText.textContent = 'Upload';
      }, 2000);
    });
  });
</script>
{% endblock %}
